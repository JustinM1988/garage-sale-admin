<!doctype html>
<html>
  <head><meta charset="utf-8"><title>OAuth Callback</title></head>
  <body style="background:#111;color:#e6e6e6;font:14px system-ui;padding:24px">
    <div id="msg">Completing sign-inâ€¦</div>
    <script type="module">
      import esriId from "https://js.arcgis.com/4.29/@arcgis/core/identity/IdentityManager.js";
      const msg = (h) => (document.getElementById("msg").innerHTML = h);

      // 1) Immediately inform the opener (works for both #access_token and ?code)
      const payload = location.hash || location.search || "";
      if (window.opener && !window.opener.closed && payload) {
        try { window.opener.postMessage({ type: "arcgis:auth", payload }, location.origin); } catch {}
      }

      // 2) Official handoff (required for PKCE)
      let ok = false;
      try {
        await esriId.completeOAuth2();
        ok = true;
      } catch (e) {
        console.error("completeOAuth2 error:", e);
      }

      msg(ok ? "<span style='color:#9be49b'>Authentication complete.</span> You can close this window."
              : "<span style='color:#ff9b9b'>Authentication failed.</span>");
      setTimeout(() => { try { window.close(); } catch {} }, 300);
    </script>
  </body>
</html>
